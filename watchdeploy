#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Look for deployment config in various locations
if [ -f "$ROOT_DIR/deployment/gitops/gitops.env" ]; then
  ENV_FILE="$ROOT_DIR/deployment/gitops/gitops.env"
elif [ -f "$ROOT_DIR/deployment/.env.deploy" ]; then
  ENV_FILE="$ROOT_DIR/deployment/.env.deploy"
else
  # Fallback to defaults or prompt? For now, we'll expect one of these.
  echo "Missing deployment environment file (deployment/gitops/gitops.env or deployment/.env.deploy)" >&2
  exit 1
fi

# Load configuration
while IFS= read -r line || [ -n "$line" ]; do
  [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue
  if [[ "$line" =~ ^[[:space:]]*([a-zA-Z_][a-zA-Z0-9_]*)[[:space:]]*=[[:space:]]*(.+)[[:space:]]*$ ]]; then
    key="${BASH_REMATCH[1]}"
    value="${BASH_REMATCH[2]}"
    value="${value%\"}"
    value="${value#\"}"
    export "$key=$value"
  fi
done < "$ENV_FILE"

if ! command -v sshpass >/dev/null 2>&1; then
  echo "sshpass is required (brew install hudochenkov/sshpass/sshpass)" >&2
  exit 1
fi

USE_TUNNEL=false
if command -v nc >/dev/null 2>&1; then
  if ! nc -z -w 2 "$hostIp" 22 2>/dev/null; then
    USE_TUNNEL=true
  fi
else
  USE_TUNNEL=true
fi


TARGET_ENV="${1:-}"
REMOTE_CMD="watchdeploy $TARGET_ENV"

if [ "$USE_TUNNEL" = "true" ]; then
  if [ -z "${SSH_DOMAIN:-}" ]; then
    echo "SSH_DOMAIN not set (add to deployment/config.sh)" >&2
    exit 1
  fi
  if ! command -v cloudflared >/dev/null 2>&1; then
    echo "cloudflared is required for tunnel mode (brew install cloudflared)" >&2
    exit 1
  fi
  sshpass -p "${password:-}" ssh -t \
    -o ProxyCommand="cloudflared access ssh --hostname $SSH_DOMAIN" \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    "$username@$SSH_DOMAIN" "$REMOTE_CMD"
else
  sshpass -p "${password:-}" ssh -t \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    "$username@$hostIp" "$REMOTE_CMD"
fi
